---
title: "HendricksonSwen_A1_take4"
author: "Swen Hendrickson"
date: "9/30/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

# load libraries
```{r}
library(tidyverse)
library(plotly)
```


# load data
```{r}
years <- 2017:2021
quarters <- 1:4
types <- c("Electric","Gas")

pge_data_raw <- NULL

for(year in years) {
  for(quarter in quarters) {
    for(type in types) {
      
      filename <-
        paste0(
          "pge_data/PGE_",
          year,
          "_Q",
          quarter,
          "_",
          type,
          "UsageByZip.csv"
        )

      # print(filename)
        
      # for Q's that don't exist
      if(!file.exists(filename)) next
      
      temp <- read_csv(filename)
      
      
      # converting to standardize units
      
      if(type == "Electric") {
        temp <-
          temp %>%
          mutate(TOTALKBTU = TOTALKWH * 3.412) %>%
          select(-AVERAGEKWH,-TOTALKWH)
      }
      
      if(type == "Gas") {
        temp <-
          temp %>%
          mutate(TOTALKBTU = TOTALTHM * 99.976) %>%
          select(-AVERAGETHM,-TOTALTHM)
      }

      pge_data_raw <-
        rbind(pge_data_raw, temp)
      
    }
  }
}
```

# manipulating data
```{r}
# make two data objects for plotting later
# one for resdiential, one for commercial
# pipeline functions: filter(), select(), mutate(), group_by(), summarise()
# residential data prep via pipes
# 
# classes <- c("Residential","Commercial")
# 
# for(class in classes) {
  pge_data_plottable <-
    pge_data_raw %>% 
    filter(
      CUSTOMERCLASS %in%
        c(
          "Elec- Commercial",
          "Elec- Residential",
          "Gas- Commercial",
          "Gas- Residential"
        )
    ) %>% 
    select(
      MONTH, YEAR, CUSTOMERCLASS, TOTALKBTU
    ) %>% 
    mutate(
      MONTH_INDEX = 12 * (YEAR %% 2017) + MONTH
    ) %>% 
    group_by(
      MONTH_INDEX, CUSTOMERCLASS
    ) %>% 
    summarise(
      TOTALKBTU = sum(TOTALKBTU, na.rm = T)
    )

#left off from textbook 1.7 3/4 down, "You'll notice that.."
```

# plotting
```{r}
# plot the RESIDENTIAL data
res_plot <-
  pge_data_plottable %>% 
  filter(
    CUSTOMERCLASS %in% c(
      "Elec- Residential",
      "Gas- Residential"
    )
  ) %>% 
  ggplot() +
  geom_bar(
    aes(
      x = MONTH_INDEX,
      y = TOTALKBTU,
      fill = CUSTOMERCLASS
    ),
    stat = "identity",
    position = "stack"
  ) +
  labs(
    x = "Month",
    y = "kBtu",
    title = "Residential Energy Use 2017-2021",
    fill = "Energy Type"
  )

res_plot %>% ggplotly()

# plot the COMMERCIAL data
com_plot <-
  pge_data_plottable %>% 
  filter(
    CUSTOMERCLASS %in% c(
      "Elec- Commercial",
      "Gas- Commercial"
    )
  ) %>% 
  ggplot() +
  geom_bar(
    aes(
      x = MONTH_INDEX,
      y = TOTALKBTU,
      fill = CUSTOMERCLASS
    ),
    stat = "identity",
    position = "stack"
  ) +
  labs(
    x = "Month",
    y = "kBtu",
    title = "Commercial Energy Use 2017-2021",
    fill = "Energy Type"
  )

com_plot %>% ggplotly()
```

# commentary
	2. Comment on any observable changes in energy consumption that may be attributable to the COVID-19 pandemic 
		a. (you are encouraged to create additional plots that help emphasize the change between 2019 and 2020). 
		b. 2019 = months 25 - 36
		c. 2020 = months 37 - 48
		d. Residential
			i. No glaring / obvious change from 2019 to 2020 energy use
		e. Commercial
			i. Noticeable dip in 2020 April, May, June (first three months of shelter in place, economy shut down)
		f. Side note: what is that huge spike in September 2017?! It occurs in both residential and commercial, mostly in electricity use but also notably in gas use.
			i. Thomas fire?
	3. Explain any key assumptions you made in the analysis, or caveats about the data sources that you think the reader should be aware of.
		a. Assumptions / Caveats:
			i. Assumptions: 
				1) assumed accuracy and thoroughness of data
				2) Didn't double check for overlapping zipcodes
			ii. Caveats:
				1) PG&E potentially not a neutral source for data
				2) i.e. might have tension considering political / reputation issues 

# next steps:
- flesh out comments, explanations
- clean up knitted html, extra text (when reading csvs)
- if time: try to plot both charts in a for loop instead of two duplicated things
- if time: also would be good to play around with line chart instead of stacked bar
