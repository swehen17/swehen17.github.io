---
title: "MonSept27_Swen_A1"
author: "Swen Hendrickson"
date: "9/27/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Libraries Chunk
```{r}
library(tidyverse)
library(plotly)
library(sf)
library(tigris)
library(leaflet)
library(censusapi)

# environmental 'settings' below
Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")
```

```{r}
pge_20_q1_elec <- read_csv("PGE_2020_Q1_ElectricUsageByZip.csv")
```

# Load Electric Data w/ Loop
```{r}
years <- 2017:2020
quarters <- 1:4
type <- "Electric"

pge_elec <- NULL

for(year in years) {
  for(quarter in quarters) {
    # if((year == 2021) & ((quarter == c(1, 2))) {
      filename <-
        paste0(
          "PGE_",
          year,
          "_Q",
          quarter,
          "_",
          type,
          "UsageByZip.csv"
        )
      
      print(filename)
    
      temp <- read_csv(filename)
      
      if()
      
      pge_elec <- rbind(pge_elec, temp)
      
      # saveRDS(pge_20_elec, "pge_20_elect.rds")
      }
        }
          

### 2021 since we only have Q3 and Q4
## TODO: find a cleaner way to do this later (with if statement)

year_2 <- 2021
quarters_2 <- 1:2
type <- "Electric"

for(year in year_2) {
  for(quarter in quarters_2) {
    filename <-
      paste0(
        "PGE_",
        year,
        "_Q",
        quarter,
        "_",
        type,
        "UsageByZip.csv"
      )

    print(filename)

    temp <- read_csv(filename)

    pge_elec <- rbind(pge_elec, temp)

    # saveRDS(pge_20_elec, "pge_20_elect.rds")
  }
}
```

# Load Gas Data w/ Loop
```{r}
years <- 2017:2020
quarters <- 1:4
type <- "Gas"

pge_gas <- NULL

for(year in years) {
  for(quarter in quarters) {
    # if((year == 2021) & ((quarter == c(1, 2))) {
      filename <-
        paste0(
          "PGE_",
          year,
          "_Q",
          quarter,
          "_",
          type,
          "UsageByZip.csv"
        )
      
      print(filename)
    
      temp <- read_csv(filename)
      
      pge_gas <- rbind(pge_gas, temp)
      
      # saveRDS(pge_20_elec, "pge_20_elect.rds")
      }
        }
          

### 2021 since we only have Q3 and Q4
## TODO: find a cleaner way to do this later (with if statement)

year_2 <- 2021
quarters_2 <- 1:2
type <- "Gas"

for(year in year_2) {
  for(quarter in quarters_2) {
    filename <-
      paste0(
        "PGE_",
        year,
        "_Q",
        quarter,
        "_",
        type,
        "UsageByZip.csv"
      )

    print(filename)

    temp <- read_csv(filename)

    pge_gas <- rbind(pge_gas, temp)

    # saveRDS(pge_20_elec, "pge_20_elect.rds")
  }
}
```

# Manipulating Data I - Filtering by Class and Type
```{r}
# make data object just with residential gas
res_gas <- 
  filter(
    pge_gas, 
    CUSTOMERCLASS %in% 
      c(
        "Gas- Residential"
        )
    )

# make data object just with commercial gas
com_gas <- 
  filter(
    pge_gas, 
    CUSTOMERCLASS %in% 
      c(
        "Gas- Commercial"
        )
    )

# make data object just with residential electric
res_elec <- 
  filter(
    pge_elec, 
    CUSTOMERCLASS %in% 
      c(
        "Elec- Residential"
        )
    )

# make data object just with commercial electric
com_elec <- 
  filter(
    pge_elec, 
    CUSTOMERCLASS %in% 
      c(
        "Elec- Commercial"
        )
    )
```


```{r}
# test plot
res_gas_chart <-
  res_gas %>% 
  ggplot() +
  geom_bar(
    aes(
      x = MONTH %>% factor(),
      y = TOTALTHM,
      # fill = CUSTOMERCLASS
    ),
    stat = "identity",
    position = "stack"
  ) +
  labs(
    x = "Month",
    y = "therms",
    title = "test plot of res gas",
    # fill = "Electricity Type"
  )

res_gas_chart
```


### manipulate data
pge_select <-
  select(
    pge_filter,
    -c(YEAR, COMBINED, AVERAGEKWH)
  )

table(pge_select$COMBINED)

pge_group <-
  group_by(
    pge_select,
    MONTH,
    CUSTOMERCLASS
  )

pge_summarize <-
  summarize(
    pge_group,
    TOTALKWH = 
      sum(
        TOTALKWH, 
        na.rm = T
      ),
    TOTALCUSTOMERS =
      sum(
        TOTALCUSTOMERS,
        na.rm = T
      )
  )

pge_mutate <-
  mutate(
    pge_summarize,
    AVERAGEKWH =
      TOTALKWH/TOTALCUSTOMERS
  )


pge_final <-
  pge_20_elec %>% 
  filter(
    CUSTOMERCLASS %in% 
      c(
        "Elec- Residential",
        "Elec- Commercial"
      )
  ) %>% 
  select(
    -c(YEAR, COMBINED, AVERAGEKWH)
  ) %>% 
  group_by(MONTH, CUSTOMERCLASS) %>% 
  summarize(
    TOTALKWH = 
      sum(
        TOTALKWH, 
        na.rm = T
      ),
    TOTALCUSTOMERS =
      sum(
        TOTALCUSTOMERS,
        na.rm = T
      )
  ) %>% 
  mutate(
    AVERAGEKWH =
      TOTALKWH/TOTALCUSTOMERS
  )
###

# Plotting Data
```{r}
pge_chart <-
  pge_final %>% 
  ggplot() +
  geom_bar(
    aes(
      x = MONTH %>% factor(),
      y = TOTALKWH,
      fill = CUSTOMERCLASS
    ),
    stat = "identity",
    position = "stack"
  ) +
  labs(
    x = "Month",
    y = "kWh",
    title = "PG&E Territory Monthly Electricity Usage, 2019",
    fill = "Electricity Type"
  )

pge_chart

# with icon bar
# pge_chart %>% ggplotly()

# without icon bar
pge_chart %>% 
  ggplotly() %>% 
  layout(
    xaxis = list(fixedrange = T),
    yaxis = list(fixedrange = T)
  ) %>% 
  config(displayModeBar = F)

# pge_wide <-
#   pivot_wider(
#     pge_summarize,
#     names_from = CUSTOMERCLASS,
#     values_from = TOTALKWH
#   
# 
# pge_wide
# 
# pge_tidy <-
#   pivot_longer(
#     pge_wide,
#     c("Elec- Commercial", "Elec- Residential"),
#     names_to = "CUSTOMERCLASS",
#     values_to = "TOTALKWH"
#   )
# pge_tidy

```










































